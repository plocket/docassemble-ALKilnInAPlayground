---
comment: |
  TODO:
  - [ ] Add project name env var. #513 PR.
  - [ ] test using default project
  - [ ] restart this session
  - [ ] start new session/interview
  - [ ] delete generated files
  - [x] Use dynamic server url
  - [x] Use dynamic project
  - [x] Use dynamic user id
  - [x] Use dynamic tags
---
mandatory: True
code: |
  #if not user_logged_in():
  #  ask_to_log_in
  #file_name
  #wants_tags
  
  #test for stackoverflow question
  #if file_name:
  #  undefine('file_name')
  #  force_ask('waiting_screen')
  
  # Try to get timer going
  #start_time
  #time_passed
  #waiting_screen
  
  wants_tags
  the_task
  #if the_task.wait():  # Will cause a timeout
  if the_task.ready():  # Won't cause a timeout
    if do_delete:
      delete_task
      if delete_task.ready():
        deleted
      else:
        wait_for_delete
  else:
    waiting_screen
---
code: |
  the_task = background_action('bg_task')
---
code: |
  delete_task = background_action('delete_artifacts')
---
code: |
  has_run_tests = False
---
event: bg_task
code: |
  import subprocess
  import os
  import json
  import re
  
  subprocess.run(['mkdir', '-p', '/var/www/.npm-global'])
  
  if False:
    outcome = subprocess.run(['npm', 'install', '-g', 'github:SuffolkLITLab/ALKiln#cli_playground'], check=False, capture_output=True, env=dict(os.environ, NPM_CONFIG_PREFIX="/var/www/.npm-global"))
    if outcome.returncode != 0:
      temp = outcome.stderr.decode('utf-8')
    else:
      temp = outcome.stdout.decode('utf-8')
  else:
    temp = "not installing"
  
  server_url = url_of('root', _external=True)
  log('================= server_url:')
  log(server_url)
  
  # if statement for idempotency - ensure tests are only run once
  if not has_run_tests:
    test_output = subprocess.run(
      ['/var/www/.npm-global/bin/alkiln-run'],
      check=False,
      capture_output=True,
      env=dict(os.environ,
        _ORIGIN='interview',
        SERVER_URL=server_url,
        _PROJECT_NAME=project_name,
        _USER_ID=f'{user_info().id}',
        _TAGS=tag_expression,
        # Don't need the values of these when running in interview
        REPO_URL="X",
        BRANCH_NAME="X",
        DOCASSEMBLE_DEVELOPER_API_KEY="X"
    ))
    has_run_tests = True
    
  log(has_run_tests)
  
  # https://github.com/SuffolkLITLab/docassemble-AssemblyLine/blob/main/docassemble/AssemblyLine/al_document.py#L1275-L1284
  # https://github.com/SuffolkLITLab/docassemble-ALDashboard/blob/main/docassemble/ALDashboard/data/questions/compile_bootstrap.yml
  
  folder_name = get_folder_name()
  log(folder_name)
  safe_zip_name = get_zip_name(folder_name)
  contents = subprocess.run(['zip', '-r', safe_zip_name, folder_name], check=False, capture_output=True)
  
  # This logs and is happy. When I abstract this elsewhere, it doesn't log.
  myfile.initialize(filename=f'{safe_zip_name}.zip')
  myfile.copy_into(f'{safe_zip_name}.zip')
  myfile.commit()
  log(myfile.path())
  
  files_html = get_files_html(folder_name)
  
  output = f"<a href='{myfile.url_for()}'>All generated files zip</a>\n\n{files_html}\n\n<pre><code>{temp}\n\n---\n\n{test_output.stdout.decode('utf-8')}{test_output.stderr.decode('utf-8')}</code></pre>"
  
  background_response(output) #.stdout.decode('utf-8').strip())
---
code: |
  import os
  
  def get_files_html(folder_name):
    '''Return html to show files in the artifacts folder.
        Syntax highlighting.'''
    html = '<div><ul>'
    
    # get all files' and folders' names
    names = os.listdir(f'/tmp/{folder_name}/.')

    
    for root_path, dir_names, file_names in os.walk(f'/tmp/{folder_name}'):
      html += '<li>\n'
      for file_name in file_names:
        # List the name of the file
        abs_file_path = os.path.abspath(os.path.join(root_path, file_name))
        html += f'<p>{abs_file_path}</p>\n'
        # Make a DAFile for each file
      html += '</li>'
      
    html += '</ul></div>'
    
    return html
---
event: delete_artifacts
code: |
  folder_name = get_folder_name()
  safe_zip_name = get_zip_name(folder_name)
  
  import os
  try:
    os.remove(f'/tmp/{safe_zip_name}.zip')
  except Exception as error:
    log('removing ZIP error:')
    log(error)
  
  import shutil
  try:
    shutil.rmtree(f'/tmp/{folder_name}')
  except Exception as error:
    log('removing FOLDER error:')
    log(error)
  
  background_response('deleted')
---
code: |
  import re
  
  def get_zip_name(folder_name):
    return re.sub("( )+", "_", folder_name)
---
code: |
  import json
  
  def get_folder_name():
    with open('/tmp/runtime_config.json') as config:
      folder_name = json.load(config)['artifacts_path']
    return folder_name
---
objects:
  - myfile: DAFile
---
code: |
  artifacted = False
---
code: |
  zipped = False
---
code: |
  from docassemble.webapp.files import SavedFile
  from docassemble.webapp.backend import directory_for
  import os

  def get_list_of_projects(user_id):
    playground = SavedFile(user_id, fix=False, section='playground')
    return playground.list_of_dirs()
    
  def get_file_paths(user_id, section='playground', project='default'):
    area = SavedFile(user_id, fix=True, section=section)
    the_directory = directory_for(area, project)
    files = [os.path.join(the_directory, file) for file in os.listdir(the_directory) if os.path.isfile(os.path.join(the_directory, file))]
    # Maybe remove the `.placeholder` file, here or later
    return files
---
event: ask_to_log_in
id: not logged in
question: |
  You need to log in
subquestion: |
  To run these tests, you need to be logged into the server where you're keeping the package that you will test.
  
  When you've logged in, come back and refresh.
---
id: test info
comment: |  
  ${ user_info().id }
  
  ${ get_list_of_projects( user_info().id ) }
  
  ${ user_info().package }
  
  ${ user_info().filename }
question: |
  How much shall I add to 553?
subquestion: |
  Not spinning: <i class="fas fa-spinner fa-spin"></i>
  
fields:
  - Do you want to use tags?: wants_tags
    datatype: yesnoradio
  - What tags do you want to use? Use a tag expression: tag_expression
    show if: wants_tags
  # What project are your test files in? Can get test files/package files from server instead of Playground?
  - What Project is the code in that you want to test?: project_name
    input type: radio
    choices:
      code: |
        [[ proj, proj ] for proj in get_list_of_projects( user_info().id )] + [['', 'Default']]
---
if:
  - not wants_tags
code: |
  tag_expression = ''
---
id: interview to test
question: |
  Which interview will you run?
subquestion: |
  Pick your file
fields:
  - What file do you run to start the interview you want to test?: file_name
    input type: radio
    choices:
      code: |
        [os.path.basename(path) for path in get_file_paths( user_info().id, project=project_name )]
---
code: |
  start_time = current_datetime()
---
reconsider: True
code: |
  current_time = current_datetime()
  time_passed = current_time - start_time
---
prevent going back: True
event: waiting_screen
reload: True
question: |
  Hang tight. Still waiting for an answer.
subquestion: |
  This screen will reload every ten seconds until the answer is available.
  
  <i class="fas fa-spinner fa-spin"></i>
  
#  ${ time_passed.minutes }min ${ time_passed.seconds }s 
#  ${ date_difference( ending=current_datetime(), starting=as_datetime(start_time) ) }
  
#back button: True
#buttons:
#  - Back: refresh
#  - Exit: exit
#    url: https://ecosia.com
---
prevent going back: True
question: |
  The answer is
subquestion: |
  
  ${ the_task.get() }
  
fields:
  - Delete generated files and folders: do_delete
    datatype: yesnoradio
---
prevent going back: True
id: wait for delete
event: wait_for_delete
reload: True
question: |
  Still deleting files and folders
---
prevent going back: True
id: deleted
event: deleted
question: |
  Files and folders deleted
---